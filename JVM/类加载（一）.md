# 类加载（一）

##  基本概念

JVM将 字节码加载到方法区，经过验证、准备、解析、初始化，最终转化为堆中Class对象的过程 称为类加载


## 类生命周期

类的生命周期包含加载、连接（验证、准备、解析）、初始化、使用、卸载 等阶段。
加载阶段和连接的部分动作是交叉进行的，并不是完全顺序的过程。

类加载 包含 加载、连接（验证、准备、解析）、初始化等三个阶段

![类生命周期](https://gitee.com/binggouxsm/JAVA-Reference/raw/master/JVM/pics/ClassLifecycle.png)

## 具体过程

### 加载

主要步骤：
1. 通过 类的全限定名 来获取定义此类的二进制字节流
2. 将字节流所代表的静态存储结构（Class File Format）转化为方法区的运行时数据结构
3. 在堆中生成这个类的Class对象，作为方法区中这个类的各种数据的访问入口

可以通过JVM参数-XX:+TraceClassLoading来看类有没有被加载

### 验证

检验class文件中字节码包含的信息是否符合虚拟机规范

[Class File Format](https://juejin.cn/post/6844904199617003528)

可以用-Xverifynone关闭大部分的验证措施，缩短类加载时间

### 准备

为类静态变量分配内存，设置为零值（0，null等）

如果变量为 static final ，则直接在准备阶段，在类的常量池中赋值，无需到初始化阶段赋值

### 解析

将常量池中符号引用替换为直接引用。解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用点限定符7类符号引用进行。

符号引用就是一组符号来描述目标，可以是任何字面量，其作用是在编译的过程中，JVM并不知道引用的具体地址，所以用符号引用进行代替，而在解析阶段将会将这个符号引用转换为真正的内存地址。

直接引用就是直接指向目标的指针、相对偏移量或一个间接定位到目标的句柄。

## 初始化

执行类构造器\<clinit\>方法

\<client\>方法是由编译器自动收集类中所有类变量的赋值动作和静态代码块中的语句合并产生的。编译器收集的顺序是有语句在资源文件中出现的顺序所决定的。

在初始化一个类时，必须先初始化其父类，因此第一个执行\<clinit\>方法的一定是Object类。

\<clinit\>方法不是必须存在的，如果一个类中没有类变量的赋值操作，也没有静态代码块，那么这个类将没有\<clinit\>方法。

如果多个线程同时希望初始化一个类，\<clinit\>方法会在多线程环境下保证正确地加锁同步，只有其中一个线程去执行这个类的\<clinit\>方法。


触发类初始化时机（主动引用）：

1. 遇到new、getstatic、putstatic、invokestatic这四条字节码指令时
  - 使用new关键字实例化对象时；对应new字节码指令
  - 读取或设置一个类的静态字段（被final修饰的、在编译期把结果放入常量池的静态变量除外）时；对应getstatic和putstatic字节码指令
  - 调用一个类的静态方法时；对应invokestatic字节码指令

2. 使用java.lang.reflect包的方法第一次对类进行反射调用时会触发类的初始化
3. 初始化类时，如果发现父类还没有初始化，则需要先触发父类的初始化
4. 虚拟机启动时，用户需要指定一个主函数类(main()方法所在的类)，虚拟机会先启动这个类
5. 使用JDK7新加入的动态语言支持时，如果一个java.lang.invoke.MethodHanlde实例最后的解析结果为REF_getstatic、REF_putstatic、REF_invokeStatic、REF_newInvokeSpecial四种类型的方法句柄时，都需要先初始化该句柄对应的类
6. 接口中定义了JDK 8新加入的默认方法（default修饰符），实现类在初始化之前需要先初始化其接口



不触发类初始化（被动引用）：
1. 子类引用父类的静态字段，只会触发子类的加载、父类的初始化，不会导致子类初始化
2. 通过数组定义来引用类，不会触发此类的初始化
3. 常量在编译阶段会进行常量优化，将常量存入调用类的常量池中，本质上并没有直接引用到定义常量的类，因此不会触发定义常量的类的初始化。

初始化触发时机的测试代码见：[链接](https://gitee.com/binggouxsm/JAVA-Reference/tree/master/JVM/program/src/main/java/com/eden/jvmlearning/classloader/initialtrigger)


## 参考文献
[一文带你深扒ClassLoader内核，揭开它的神秘面纱！](https://www.sohu.com/a/436313969_427741)